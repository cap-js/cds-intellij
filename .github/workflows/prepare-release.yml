name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      lsp_impact:
        description: 'LSP impact override (auto = detect from version change)'
        required: false
        type: choice
        options:
          - 'auto'
          - 'no-update'
          - 'patch'
          - 'minor'
          - 'major'
        default: 'auto'
      plugin_impact:
        description: 'Plugin impact override (auto = detect from commits)'
        required: false
        type: choice
        options:
          - 'auto'
          - 'patch'
          - 'minor'
          - 'major'
        default: 'auto'

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ github.workspace }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Translate inputs
        id: translate
        run: |
          LSP_INPUT="${{ inputs.lsp_impact || 'auto' }}"
          PLUGIN_INPUT="${{ inputs.plugin_impact || 'auto' }}"
          
          case "$LSP_INPUT" in
            auto) LSP_NUM="auto" ;;
            no-update) LSP_NUM=0 ;;
            patch) LSP_NUM=1 ;;
            minor) LSP_NUM=2 ;;
            major) LSP_NUM=3 ;;
          esac
          
          case "$PLUGIN_INPUT" in
            auto) PLUGIN_NUM="auto" ;;
            patch) PLUGIN_NUM=1 ;;
            minor) PLUGIN_NUM=2 ;;
            major) PLUGIN_NUM=3 ;;
          esac
          
          echo "lsp_impact=$LSP_NUM" >> $GITHUB_OUTPUT
          echo "plugin_impact=$PLUGIN_NUM" >> $GITHUB_OUTPUT
      
      - name: Get current versions
        id: versions
        run: bash -x src/sh/release/get-versions.sh "${{ steps.translate.outputs.lsp_impact }}"
      
      - name: Calculate new version
        id: new_version
        run: |
          bash -x src/sh/release/calculate-new-version.sh \
            "${{ steps.versions.outputs.current_plugin }}" \
            "${{ steps.versions.outputs.lsp_impact }}" \
            "${{ steps.translate.outputs.plugin_impact }}" \
            "${{ steps.versions.outputs.last_tag }}"
      
      - name: Generate changelog
        id: changelog
        run: bash -x src/sh/release/generate-changelog.sh "${{ steps.versions.outputs.last_tag }}" HEAD
      
      - name: Update files
        run: |
          bash -x src/sh/release/update-gradle-version.sh "${{ steps.new_version.outputs.version }}"
          bash -x src/sh/release/update-plugin-xml-changelog.sh "${{ steps.changelog.outputs.changelog }}"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: release/v${{ steps.new_version.outputs.version }}
          title: 'chore(release): bump version to ${{ steps.new_version.outputs.version }}'
          body: |
            **Version:** ${{ steps.versions.outputs.current_plugin }} → ${{ steps.new_version.outputs.version }} (bump: ${{ steps.new_version.outputs.bump_level }})
            
            **LSP:** ${{ steps.versions.outputs.old_lsp }} → ${{ steps.versions.outputs.current_lsp }}
            - Detected impact: ${{ steps.versions.outputs.lsp_impact }}
            - Bump level: ${{ steps.new_version.outputs.lsp_bump_level }}
            
            **Plugin:** ${{ inputs.plugin_impact || 'auto' }}
            - Bump level: ${{ steps.new_version.outputs.plugin_bump_level }}
            
            ---
            
            ${{ steps.changelog.outputs.changelog }}
          commit-message: 'chore(release): bump version to ${{ steps.new_version.outputs.version }}'
          labels: release
