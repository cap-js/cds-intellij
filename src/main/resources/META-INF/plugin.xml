<idea-plugin>
    <id>com.sap.cap.cds</id>
    <name>SAP CDS Language Support</name>
    <vendor url="https://sap.com/">SAP SE</vendor>
    <description><![CDATA[ Provides support for the <a href="https://cap.cloud.sap/docs/cds/">CDS language</a> in IntelliJ IDEs. Use these powerful features:
<ul>
    <li>Syntax highlighting</li>
    <li>Code completion</li>
    <li>Go to definition, declaration, and implementation</li>
    <li>Find references</li>
    <li>Highlight usages in file</li>
    <li>Structure tool window (Outline)</li>
    <li>Hover documentation</li>
    <li>Document and range formatting</li>
    <li>Diagnostics (errors and warnings)</li>
    <li>Quick fixes</li>
    <li>Document links</li>
    <li>Semantic Tokens</li>
    <li>Workspace symbols</li>
    <li>Code lens</li>
    <li>Dependency analysis</li>
</ul>]]></description>

    <depends>com.intellij.modules.platform</depends>
<!--    <depends>com.intellij.modules.ultimate</depends>-->
    <depends>org.jetbrains.plugins.textmate</depends>
    <depends optional="true" config-file="withNodeJs.xml">NodeJS</depends>


    <extensions defaultExtensionNs="com.intellij">
        <fileType
                name="cds"
                implementationClass="com.sap.cap.cds.intellij.CdsFileType"
                fieldName="INSTANCE"
                language="cds"
                extensions="cds"/>

        <notificationGroup id="com.sap.cap.cds.intellij.notifications"
                           displayType="BALLOON"/>

        <lang.substitutor language="cds" order="first"
                          implementationClass="com.sap.cap.cds.intellij.lang.CdsLanguageSubstitutor"/>

        <langCodeStyleSettingsProvider
                implementation="com.sap.cap.cds.intellij.codestyle.CdsCodeStyleSettingsProvider"/>

        <formattingService implementation="com.sap.cap.cds.intellij.codestyle.CdsCodeStylePreviewFormattingService"/>

        <intentionAction>
            <className>com.sap.cap.cds.intellij.httpFiles.HttpFileCompatConversionIntention</className>
        </intentionAction>

<!--        <notificationGroup id="com.sap.cap.cds.intellij.notifications"-->
<!--                           displayType="BALLOON"/>-->

        <vfs.asyncListener implementation="com.sap.cap.cds.intellij.codestyle.CdsPrettierJsonListener"/>
        <vfs.asyncListener implementation="com.sap.cap.cds.intellij.usersettings.CdsUserSettingsListener"/>
        <postStartupActivity implementation="com.sap.cap.cds.intellij.lifecycle.ProjectLifecycleListener"/>

        <applicationService
                serviceImplementation="com.sap.cap.cds.intellij.settings.AppSettings"/>
        <projectService
                serviceImplementation="com.sap.cap.cds.intellij.usersettings.CdsUserSettings"/>
        <projectService
                serviceImplementation="com.sap.cap.cds.intellij.usersettings.CdsUserSettingsService"/>
        <applicationConfigurable
                parentId="language"
                id="com.sap.cap.cds.intellij.settings.AppSettingsConfigurable"
                instance="com.sap.cap.cds.intellij.settings.AppSettingsConfigurable"
                displayName="CDS"/>
        <projectConfigurable
                parentId="com.sap.cap.cds.intellij.settings.AppSettingsConfigurable"
                id="com.sap.cap.cds.intellij.usersettings.CdsUserSettingsConfigurable"
                instance="com.sap.cap.cds.intellij.usersettings.CdsUserSettingsConfigurable"
                displayName="Language Server"/>

    </extensions>

    <depends>com.redhat.devtools.lsp4ij</depends>

    <extensions defaultExtensionNs="com.redhat.devtools.lsp4ij">
        <server id="cds"
                name="CDS Language Server"
                factoryClass="com.sap.cap.cds.intellij.lsp4ij.CdsLanguageServerFactory">
            <description><![CDATA[
        <h2>SAP CDS Language Support</h2>
        ]]>
            </description>

        </server>

        <fileNamePatternMapping patterns="*.cds"
                                serverId="cds"
                                languageId="cds"/>

        <languageMapping language="cds"
                         serverId="cds"
                         languageId="cds"/>



<!-- TODO? e.g. csn or json       <languageMapping language="XML"-->
<!--                         serverId="myLanguageServerId"-->
<!--                         documentMatcher="my.language.server.MyDocumentMatcher"/>-->
    </extensions>

    <applicationListeners>
        <listener
                topic="com.intellij.ide.AppLifecycleListener"
                class="com.sap.cap.cds.intellij.lifecycle.IdeLifecycleListener"
                activeInHeadlessMode="true" activeInTestMode="true"
        />
        <listener
                topic="com.intellij.ide.plugins.DynamicPluginListener"
                class="com.sap.cap.cds.intellij.lifecycle.PluginLifecycleListener"
                activeInHeadlessMode="true" activeInTestMode="true"
        />
    </applicationListeners>


    <actions>
        <!-- groups -->
        
        <group id="com.sap.cap.cds.intellij.group.cds"
               text="CDS"
               popup="true"
               icon="com.sap.cap.cds.intellij.CdsIcons.SERVER">
        </group>
        <group id="com.sap.cap.cds.intellij.group.cds.logs.lspServer"
               text="LSP Server Logs"
               popup="true">
            <add-to-group group-id="com.sap.cap.cds.intellij.group.cds"
                          anchor="first"/>
        </group>
        <group id="com.sap.cap.cds.intellij.group.cds.logs.stdio"
               text="LSP Stdio Logs"
               popup="true">
            <add-to-group group-id="com.sap.cap.cds.intellij.group.cds"
                          anchor="last"/>
        </group>

        <!-- actions -->
        
        <action id="com.sap.cap.cds.intellij.showLspServerLogs"
                class="com.sap.cap.cds.intellij.lspServer.ShowLspServerLogsAction"
                text="Show Log File"
                description="Opens the most recent CDS LSP server log file.">
            <add-to-group group-id="com.sap.cap.cds.intellij.group.cds.logs.lspServer"
                          anchor="first"/>
        </action>

        <action id="com.sap.cap.cds.intellij.copyLspServerLogsPath"
                class="com.sap.cap.cds.intellij.lspServer.CopyLspServerLogPathAction"
                text="Copy Log File Path"
                description="Copies the path of the most recent CDS LSP server log file to the clipboard.">
            <add-to-group group-id="com.sap.cap.cds.intellij.group.cds.logs.lspServer"
                          anchor="last"/>
        </action>

        <action id="com.sap.cap.cds.intellij.showStdioLogs"
                class="com.sap.cap.cds.intellij.lsp.ShowStdioLogsAction"
                text="Show Log File"
                description="Opens the stdio log file.">
            <add-to-group group-id="com.sap.cap.cds.intellij.group.cds.logs.stdio"
                          anchor="first"/>
        </action>

        <action id="com.sap.cap.cds.intellij.copyStdioLogsPath"
                class="com.sap.cap.cds.intellij.lsp.CopyStdioLogPathAction"
                text="Copy Log File Path"
                description="Copies the path of the stdio log file to the clipboard.">
            <add-to-group group-id="com.sap.cap.cds.intellij.group.cds.logs.stdio"
                          anchor="last"/>
        </action>
    </actions>



    <change-notes><![CDATA[
<h4>Added</h4>
<ul>
    <li>Enable telemetry by default (disabled via user setting <code>sapbas.telemetryEnabled</code>)</li>
</ul>
<h4>Changed</h4>
<ul>
    <li>Upgrade LSP4IJ to 0.19.1, fixing CDS language support in WSL workspaces and tab-size configuration</li>
    <li>Upgrade cds-lsp to 9.6.2 with the following changes since 9.4.0:
        <ul>
            <li>Telemetry support independent from client</li>
            <li>Fixed syntax highlighting in bracketed expressions and <code>annotate</code> statements with constraints containing function calls</li>
            <li><code>*.json</code> files are no longer scanned and parsed heuristically if they contain CSN. Those files need to be used from a CDS file to be seen e.g. in <code>Workspace Symbols</code>. However, files ending with <code>.csn.json</code> or <code>.csn</code> are still considered as CSN files.</li>
            <li>Removed user setting <code>cds.workspace.debounceFastChanges</code>, now always enabled</li>
            <li>(Experimental) persistency of where-used index (enabled via user setting <code>cds.workspace.persistency.enabled</code> with more fine-tuning settings available)</li>
            <li>Compatibility with <code>@sap/cds 9.5</code></li>
        </ul>
    </li>
    <li>Update cds-lsp user settings and defaults, improve UX</li>
</ul>
<h4>Fixed</h4>
<ul>
    <li>Always use configured/default CDS tabSize</li>
    <li>Resolve race condition in language-server startup</li>
</ul>
<p><em>For details see the <a href=https://github.com/cap-js/cds-intellij/compare/2.0.1...2.1.0>full changelog</a></em></p>
]]></change-notes>
</idea-plugin>
